name: Clean SharePoint Sites (Certificate)

on:
  workflow_dispatch:

jobs:
  clean-spo:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install module, connect and clean
        shell: pwsh
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          SPO_CERT_PASSWORD: ${{ secrets.SPO_CERTIFICATE_PASSWORD }}
          SPO_CERT_BASE64: ${{ secrets.SPO_CERTIFICATE_BASE64 }}
        run: |
          Write-Host "Installing module..." -ForegroundColor Cyan
          Install-Module Microsoft.Online.SharePoint.PowerShell -Force -AllowClobber
          Import-Module Microsoft.Online.SharePoint.PowerShell -Force
          
          Write-Host "Decoding certificate..." -ForegroundColor Cyan
          $bytes = [Convert]::FromBase64String($env:SPO_CERT_BASE64)
          [IO.File]::WriteAllBytes("$env:TEMP\spo-cert.pfx", $bytes)
          
          Write-Host "Connecting to SharePoint..." -ForegroundColor Cyan
          $certPassword = ConvertTo-SecureString $env:SPO_CERT_PASSWORD -AsPlainText -Force
          Connect-SPOService -Url "https://1xyj7c-admin.sharepoint.com" `
            -ClientId $env:AZURE_CLIENT_ID `
            -CertificatePath "$env:TEMP\spo-cert.pfx" `
            -CertificatePassword $certPassword
          
          $protectedSites = @(
            "https://1xyj7c.sharepoint.com/sites/allcompany",
            "https://1xyj7c.sharepoint.com/sites/appcatalog",
            "https://1xyj7c.sharepoint.com",
            "https://1xyj7c.sharepoint.com/sites/wcontosoteam",
            "https://1xyj7c.sharepoint.com/sites/DigitalInitiativePublicRelations2",
            "https://1xyj7c.sharepoint.com/sites/wgive",
            "https://1xyj7c.sharepoint.com/sites/wlive",
            "https://1xyj7c.sharepoint.com/sites/MSFT",
            "https://1xyj7c.sharepoint.com/sites/SalesandMarketing",
            "https://1xyj7c.sharepoint.com/sites/U.S.Sales",
            "https://1xyj7c.sharepoint.com/sites/work"
          )
          
          Write-Host "`nGetting all sites..." -ForegroundColor Cyan
          $allSites = Get-SPOSite -Limit All
          $deletedCount = 0
          $keptCount = 0
          
          foreach ($site in $allSites) {
            if ($site.Url -eq "https://1xyj7c.sharepoint.com") {
              Write-Host "⏭️  Skipping root site" -ForegroundColor Gray
              continue
            }
            
            if ($protectedSites -contains $site.Url) {
              Write-Host "⏭️  Keeping: $($site.Url)" -Foregro